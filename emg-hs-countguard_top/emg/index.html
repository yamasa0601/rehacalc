<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EMG歩行解析（スマホ対応・サーバ不要）</title>
  <link rel="stylesheet" href="./style.css" />
  <!-- Plotly (for plotting + PNG export) -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>
<body>
  <header class="top">
    <div>
      <h1>EMG歩行解析（スマホ対応）</h1>
      <p class="sub">CSV1=TAでHS推定 → %peak → 同じHSでCSV1/CSV2を0–100%正規化 → 平均±SD → PNG保存</p>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>1) CSVを選択（2つ）</h2>
      <div class="grid2">
        <div class="box">
          <label class="lbl">CSV 1（TA推奨：HS基準）</label>
          <input id="file1" type="file" accept=".csv" />
          <div class="row">
            <label class="lbl2">信号列</label>
            <select id="sigcol1"></select>
          </div>
          <div class="row">
            <label class="lbl2">時間列</label>
            <select id="timecol1"></select>
          </div>
          <p class="hint">※ センサ形式（No,電圧mV,event）なら自動判別します</p>
        </div>

        <div class="box">
          <label class="lbl">CSV 2（測定筋：HSはCSV1(TA)を使用）</label>
          <input id="file2" type="file" accept=".csv" />
          <div class="row">
            <label class="lbl2">信号列</label>
            <select id="sigcol2"></select>
          </div>
          <div class="row">
            <label class="lbl2">時間列</label>
            <select id="timecol2"></select>
          </div>
          <p class="hint">※ 列の選択は「読み込み後」に自動で候補が出ます</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>2) 解析設定</h2>
      <div class="grid3">
        <div class="box">
          <label class="lbl2">サンプリング周波数 (Hz)</label>
          <input id="fs" type="number" value="1000" min="100" max="5000" step="1"/>
        </div>

        <div class="box">
          <label class="lbl2">静止区間 (秒)（開始〜3秒は静止推奨）</label>
          <input id="baseline" type="number" value="3" min="0" max="20" step="0.5"/>
          <p class="hint">この区間のノイズから閾値を自動決定します</p>
        </div>

        <div class="box">
          <label class="lbl2">BandPass (Hz)</label>
          <div class="row">
            <input id="hp" type="number" value="50" min="1" max="500" step="1"/> <span class="unit">〜</span>
            <input id="lp" type="number" value="450" min="10" max="1000" step="1"/>
          </div>
        </div>
        <div class="box">
          <label class="lbl2">RMS窓 (ms)</label>
          <input id="rmsms" type="number" value="50" min="1" max="500" step="1"/>
        </div>

        <div class="box">
          <label class="lbl2">最小バースト持続 (ms)</label>
          <input id="minburst" type="number" value="30" min="5" max="500" step="1"/>
        </div>
        <div class="box">
          <label class="lbl2">最小HS間隔 (ms)（二重抑制）</label>
          <input id="mingap" type="number" value="650" min="50" max="3000" step="10"/>
          <p class="hint">同一脚HSは0.7–1.5秒程度が多いので、速歩でも650ms推奨</p>
        </div>
        <div class="box">
          <label class="lbl2">HSオフセット (ms)（onset→HS補正）</label>
          <input id="offset" type="number" value="80" min="-200" max="200" step="5"/>
          <p class="hint">TAは立ち上がり→HSまで50–100ms程度ズレることがあるので、まず80ms推奨</p>
        </div>

        <div class="box">
          <label class="lbl2">動画で目視したHS数（だいたいでOK）</label>
          <input id="steps" type="number" value="0" min="0" max="500" step="1"/>
          <label class="lbl2" style="margin-top:8px;">HS数 許容差 (±)</label>
          <input id="stepstol" type="number" value="2" min="0" max="20" step="1"/>
          <p class="hint">0なら完全自動。入力すると「検出HS数が大きく外れない」ように重み付けします。</p>
        </div>

        <div class="box">
          <label class="lbl2">周期正規化点数</label>
          <input id="npoints" type="number" value="501" min="101" max="2001" step="50"/>
        </div>

        <div class="box">
          <label class="lbl2">個別周期を表示</label>
          <select id="showind">
            <option value="1" selected>表示する</option>
            <option value="0">表示しない</option>
          </select>
        </div>
      </div>

      <div class="box" style="margin-top:12px;">
        <label class="lbl2">（任意）動画で確認したHS（手入力：一覧 or HS数）</label>
        <textarea id="hsmanual" rows="4" placeholder="HS数だけなら： 10 または 10HS
HS一覧なら：
3620
4780
...（サンプルNo=1始まり）
または 3.620s / 3620ms もOK"></textarea>

        <div class="row" style="margin-top:10px; gap:10px;">
          <div style="flex:1;">
            <label class="lbl2">許容誤差 (ms)（動画HSと自動HSの一致判定）</label>
            <input id="hstol" type="number" value="80" min="10" max="300" step="10"/>
          </div>
          <div style="flex:1;">
            <label class="lbl2">手入力HSの使い方</label>
            <select id="hsuse">
              <option value="check" selected>自動HSの妥当性チェックのみ</option>
              <option value="use">手入力HSで周期分割（自動が不安定な時）</option>
            </select>
          </div>
        </div>

        <p class="hint">※ HS一覧が無い場合は「HS数」だけ入れる運用でOKです（精度は count を優先して最適化します）。</p>
        <div id="hsreport" class="hint"></div>
      </div>

      <div class="actions">
        <button id="run" class="primary">解析してプロット</button>
        <button id="clear">クリア</button>
      </div>

      <div id="msg" class="msg"></div>
    </section>

    <section class="card">
      <h2>3) 結果</h2>

      <div class="grid2">
        <div class="box">
          <h3 id="name1">CSV 1</h3>
          <div class="mini">
            <div><b>推定HS数</b>: <span id="hsn1">-</span></div>
            <div><b>k(MAD)</b>: <span id="kmad1">-</span></div>
            <div><b>周期数</b>: <span id="cycn1">-</span></div>
          </div>

          <div class="btnrow">
            <button id="dlhs1">HS一覧CSVを保存</button>
            <button id="dlpng1">プロットPNGを保存</button>
          </div>

          <div id="plot1" class="plot"></div>
          <details>
            <summary>デバッグ（%peak包絡 + HS）</summary>
            <div id="debug1" class="plot"></div>
          </details>
        </div>

        <div class="box">
          <h3 id="name2">CSV 2</h3>
          <div class="mini">
            <div><b>推定HS数</b>: <span id="hsn2">-</span></div>
            <div><b>k(MAD)</b>: <span id="kmad2">-</span></div>
            <div><b>周期数</b>: <span id="cycn2">-</span></div>
          </div>

          <div class="btnrow">
            <button id="dlhs2">HS一覧CSVを保存</button>
            <button id="dlpng2">プロットPNGを保存</button>
          </div>

          <div id="plot2" class="plot"></div>
          <details>
            <summary>デバッグ（%peak包絡 + HS）</summary>
            <div id="debug2" class="plot"></div>
          </details>
        </div>
      </div>

      <div class="note">
        <p><b>ポイント</b>：今回は「動画で目視したHS数」を重み付けして最適化します。<br>
        例えば動画で10回くらいなら、検出結果が20回などに大きく外れないように（1つ飛ばし/間引きも含めて）自動調整します。</p>
      </div>
    </section>

    <footer class="foot">
      <p>rehacalc内に追加してGitHub Pagesで運用可能（サーバ不要）。</p>
    </footer>
  </main>

  <script type="module" src="./app.js"></script>
</body>
</html>
