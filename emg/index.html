<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>EMG歩行解析（スマホ対応）</title>
  <link rel="stylesheet" href="./style.css" />
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>

<body>
  <header class="top">
    <h1>EMG歩行解析（スマホ対応）</h1>
    <p class="sub">CSVを2つ選ぶ（CSV1=TA推奨） →（任意）動画でHS補助 → %peak → TAのHSで周期0–100%正規化 → 平均±SD → PNG保存</p>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>1) 入力</h2>

      <div class="grid2">
        <div class="field">
          <label>CSV 1（TA推奨）</label>
          <input id="file1" type="file" accept=".csv" />
        </div>

        <div class="field">
          <label>CSV 2（測定筋）</label>
          <input id="file2" type="file" accept=".csv" />
        </div>
      </div>

      <details class="details">
        <summary>列の選択（表形式CSVの場合のみ）</summary>
        <div class="grid2">
          <div class="field">
            <label>CSV1: 信号列</label>
            <select id="sigcol1"></select>
          </div>
          <div class="field">
            <label>CSV1: 時間列</label>
            <select id="timecol1"></select>
          </div>
          <div class="field">
            <label>CSV2: 信号列</label>
            <select id="sigcol2"></select>
          </div>
          <div class="field">
            <label>CSV2: 時間列</label>
            <select id="timecol2"></select>
          </div>
        </div>
        <p class="note">※ センサ形式（No, 電圧mV, …）の場合は自動で読まれます。</p>
      </details>
    </section>

    <section class="card">
      <h2>2) 前処理・HS推定設定</h2>

      <div class="grid3">
        <div class="field">
          <label>サンプリング周波数 (Hz)</label>
          <input id="fs" type="number" value="1000" />
        </div>
        <div class="field">
          <label>HighPass (Hz)</label>
          <input id="hp" type="number" value="50" />
        </div>
        <div class="field">
          <label>LowPass (Hz)</label>
          <input id="lp" type="number" value="450" />
        </div>

        <div class="field">
          <label>RMS窓 (ms)</label>
          <input id="rmsms" type="number" value="50" />
        </div>

        <div class="field">
          <label>最小バースト幅 (ms)</label>
          <input id="minburst" type="number" value="30" />
        </div>

        <div class="field">
          <label>最小HS間隔 (ms)（二重抑制）</label>
          <input id="mingap" type="number" value="450" />
        </div>

        <div class="field">
          <label>HSオフセット (ms)（onset→HS補正）</label>
          <input id="offset" type="number" value="80" />
        </div>

        <div class="field">
          <label>動画の歩数（分かるなら）</label>
          <input id="steps" type="number" value="0" />
          <div class="mini">0なら自動（歩行らしい周期でスコアリング）</div>
        </div>

        <div class="field">
          <label>周期正規化点数</label>
          <input id="npoints" type="number" value="501" />
        </div>

        <div class="field">
          <label>個別周期を表示</label>
          <select id="showind">
            <option value="0">表示しない</option>
            <option value="1">表示する</option>
          </select>
        </div>
      </div>

      <div class="btnrow">
        <button id="run" class="btn primary">解析してプロット</button>
        <button id="clear" class="btn">クリア</button>
      </div>

      <p id="msg" class="msg">CSVを2つ選択して「解析してプロット」を押してください。</p>
    </section>

    <section class="card">
      <h2>（任意）動画でHS補助（倍検出の間引き）</h2>
      <p class="note">
        1) MP4を選択 → 2) 動画の足付近を1回タップしてROI指定 → 3)「動画からイベント抽出」→ 4)「解析してプロット」<br/>
        ※ 最初3秒静止の条件を使って、動画の動き閾値を安定化します。
      </p>

      <div class="grid2">
        <div class="field">
          <label>動画 (mp4)</label>
          <input id="videoFile" type="file" accept="video/mp4,video/*" />
        </div>

        <div class="field">
          <label>動画補助を使う</label>
          <label class="switch">
            <input id="useVideoAssist" type="checkbox" checked />
            <span>ON</span>
          </label>
        </div>
      </div>

      <div class="videoBox">
        <div class="videoWrap">
          <video id="video" playsinline webkit-playsinline controls muted></video>
          <canvas id="overlay"></canvas>
        </div>
        <div class="vctrl">
          <div class="grid3">
            <div class="field">
              <label>ROIサイズ（px）</label>
              <input id="roiSize" type="number" value="180" />
              <div class="mini">足が入る程度に調整</div>
            </div>

            <div class="field">
              <label>静止区間（秒）</label>
              <input id="baselineSec" type="number" value="3" />
            </div>

            <div class="field">
              <label>動画イベント最小間隔（ms）</label>
              <input id="videoMinGap" type="number" value="500" />
            </div>

            <div class="field">
              <label>一致許容（ms）</label>
              <input id="matchTol" type="number" value="120" />
            </div>

            <div class="field">
              <label>同期探索範囲（±秒）</label>
              <input id="syncRange" type="number" value="5" />
            </div>

            <div class="field">
              <label>動画サンプルFPS（目安）</label>
              <input id="videoFps" type="number" value="20" />
            </div>
          </div>

          <div class="btnrow">
            <button id="analyzeVideo" class="btn">動画からイベント抽出</button>
            <button id="clearVideo" class="btn">動画クリア</button>
          </div>

          <p id="videoStatus" class="msg">動画未選択（補助なしでも解析できます）</p>

          <details class="details">
            <summary>動画デバッグ（動き量・イベント）</summary>
            <div id="videoPlot" class="plot"></div>
          </details>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3) 結果</h2>

      <div class="resultCard">
        <h3 id="name1">CSV 1（TA推奨）</h3>
        <div class="stats">
          <div>推定HS数: <span id="hsn1">-</span></div>
          <div>k(MAD): <span id="kmad1">-</span></div>
          <div>周期数: <span id="cycn1">-</span></div>
          <div>HSソース: <span id="hssrc">-</span></div>
        </div>
        <div class="btnrow">
          <button id="dlhs1" class="btn">HS一覧CSVを保存</button>
          <button id="dlpng1" class="btn">プロットPNGを保存</button>
        </div>
        <div id="plot1" class="plot"></div>

        <details class="details">
          <summary>デバッグ（%peak包絡 + HS）</summary>
          <div id="debug1" class="plot"></div>
        </details>
      </div>

      <div class="resultCard">
        <h3 id="name2">CSV 2（測定筋：TAのHSで周期化）</h3>
        <div class="stats">
          <div>HS数(参照): <span id="hsn2">-</span></div>
          <div>k(MAD): <span id="kmad2">-</span></div>
          <div>周期数: <span id="cycn2">-</span></div>
          <div>HSソース: <span id="hssrc2">-</span></div>
        </div>
        <div class="btnrow">
          <button id="dlhs2" class="btn">HS一覧CSVを保存</button>
          <button id="dlpng2" class="btn">プロットPNGを保存</button>
        </div>
        <div id="plot2" class="plot"></div>

        <details class="details">
          <summary>デバッグ（%peak包絡 + HS）</summary>
          <div id="debug2" class="plot"></div>
        </details>
      </div>
    </section>

    <footer class="foot">
      <p class="note">
        推奨運用：CSV1=TA固定（2chの片方は必ずTA）→ TAのHSでCSV2を周期化。<br/>
        倍検出が出る場合：動画補助ON + ROIを足に合わせる + minGap(450〜650ms)。
      </p>
    </footer>
  </main>

  <script src="./app.js"></script>
</body>
</html>

  
           
